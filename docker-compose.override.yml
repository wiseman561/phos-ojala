version: "3.9"

services:
  vault:
    image: hashicorp/vault:1.15.2
    container_name: phos-vault
    ports:
      - "8200:8200"
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=root
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
      - VAULT_ADDR=http://0.0.0.0:8200
    cap_add:
      - IPC_LOCK
    command: vault server -dev -dev-root-token-id=root
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - phos-network

  vault-agent-phos-api:
    build:
      context: ./vault
      dockerfile: Dockerfile
    container_name: phos-vault-agent-api
    depends_on:
      vault:
        condition: service_healthy
    environment:
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=root
    volumes:
      - phos-secrets:/vault/secrets
      - ./vault/role-id:/vault/config/role-id:ro
      - ./vault/secret-id:/vault/config/secret-id:ro
    restart: unless-stopped
    healthcheck:
      disable: true    # disable dev-time Vault health probes
    networks:
      - phos-network

  phos-db:
    image: postgres:15
    container_name: phos-db
    environment:
      - POSTGRES_DB=phos
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=yourpassword
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - phos-network

  phos-api:
    build:
      context: .
      dockerfile: src/backend/Phos.Api/Dockerfile
    container_name: phos-api
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
    ports:
      - "8080:80"
    depends_on:
      - phos-db
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - phos-network

  # ───────── EF-Core migrator (runs once) ─────────
  phos-identity-migrator:
    image: mcr.microsoft.com/dotnet/sdk:8.0
    working_dir: /src
    volumes:
      - ./:/src
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__Default=Host=phos-db;Port=5432;Database=phos;Username=postgres;Password=postgres
    entrypoint: ["/bin/sh","-c"]
    command: |
      set -e
      echo "Installing EF Core tools..."
      dotnet tool install --global dotnet-ef --version 8.0.* || true
      echo "Adding tools to PATH..."
      export PATH="$PATH:/root/.dotnet/tools"
      echo "Restoring project..."
      dotnet restore src/backend/Phos.Identity/Phos.Identity.csproj -p:ManagePackageVersionsCentrally=false
      echo "Running migrations..."
      dotnet ef database update \
        --project src/backend/Phos.Identity/Phos.Identity.csproj \
        --startup-project src/backend/Phos.Identity/Phos.Identity.csproj \
        --no-build \
        --verbose
    depends_on:
      phos-db:
        condition: service_healthy
    restart: "no"

  # ───────── API (runtime image, slim) ─────────
  phos-identity:
    build:
      context: .
      dockerfile: src/backend/Phos.Identity/Dockerfile
    ports:
      - "5501:8080"          # host 5501 → container 8080
    depends_on:
      phos-identity-migrator:
        condition: service_completed_successfully
      phos-db:
        condition: service_healthy

  phos-healthscore:
    build:
      context: .
      dockerfile: src/backend/Phos.HealthScore/Dockerfile
    container_name: phos-healthscore
    ports:
      - "5004:80"
    depends_on:
      phos-db:
        condition: service_started
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - JwtSettings__SecretKey=YOUR_SUPER_SECRET_KEY_HERE_THAT_IS_AT_LEAST_32_CHARACTERS_LONG
      - JwtSettings__Issuer=Phos.Identity
      - JwtSettings__Audience=Phos.Client
      - JwtSettings__ExpiryInMinutes=60
      - ConnectionStrings__DefaultConnection=Host=phos-db;Port=5432;Database=phos;Username=postgres;Password=yourpassword
    restart: unless-stopped
    networks:
      - phos-network

  phos-apigateway:
    build:
      context: .
      dockerfile: src/backend/Phos.ApiGateway/Dockerfile
    container_name: phos-apigateway
    ports:
      - "5050:80"
    depends_on:
      - phos-api
      - phos-identity
      - phos-healthscore
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - JwtSettings__Authority=http://localhost:5001
      - JwtSettings__Issuer=Phos.Identity
      - JwtSettings__Audience=Phos.Client
      - JwtSettings__SecretKey=YOUR_SUPER_SECRET_KEY_HERE_THAT_IS_AT_LEAST_32_CHARACTERS_LONG
      - JwtSettings__ExpiryInMinutes=60
    restart: unless-stopped
    networks:
      - phos-network

  phos-web:
    build:
      context: ./src/frontend/phos-web
    environment:
      - NODE_ENV=development
    ports:
      - "${PHOS_WEB_PORT:-3000}:3000"
    volumes:
      - ./src/frontend/phos-web:/app
      - /app/node_modules
    depends_on:
      - phos-apigateway
    restart: unless-stopped
    networks:
      - phos-network

  phos-web-dev:
    image: node:20
    container_name: phos-web-dev
    working_dir: /app
    command: >
      sh -c "npm install && npm run dev -- --host 0.0.0.0"
    volumes:
      - ./src/frontend/phos-web:/app
    ports:
      - "3001:3000"
    environment:
      - VITE_API_BASE=http://localhost:5001
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - phos-network

volumes:
  phos-secrets:
    driver: local
  postgres_data:
    driver: local

networks:
  phos-network:
    driver: bridge
