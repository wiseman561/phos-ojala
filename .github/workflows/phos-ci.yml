name: PHOS CI

on:
  push:
    branches: [ main, develop, rename-to-phos ]
  pull_request:
    branches: [ main, develop, rename-to-phos ]

jobs:
  doctor:
    name: Repo Doctor
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Set up .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - name: Run doctor
        shell: pwsh
        run: |
          ./phos/scripts/doctor.ps1 -Verbose

  lint-ui:
    name: Lint and Type Check UI
    runs-on: ubuntu-latest
    needs: doctor
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: phos/apps/phos-ui/package-lock.json
      - name: Install deps
        working-directory: phos/apps/phos-ui
        run: npm ci --no-audit --fund=false
      - name: TypeScript check
        working-directory: phos/apps/phos-ui
        run: npx tsc --noEmit
      - name: ESLint (if configured)
        working-directory: phos/apps/phos-ui
        run: |
          if [ -f .eslintrc ] || [ -f .eslintrc.js ] || [ -f .eslintrc.cjs ] || [ -f .eslintrc.json ]; then
            npx eslint .
          else
            echo "Skipping ESLint: no ESLint config found"
          fi

  build-services:
    name: Build Services
    runs-on: ubuntu-latest
    needs: doctor
    strategy:
      matrix:
        service:
          - lab-interpreter
          - nutrition-kit
          - genome-kit
          - microbiome-kit
          - sleep-kit
          - phos-core
          - phos-sync
    steps:
      - uses: actions/checkout@v4
      - name: Set up .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', 'Directory.Packages.props', 'global.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      - name: Restore and build
        working-directory: phos/services/${{ matrix.service }}
        run: |
          dotnet restore
          dotnet build -c Release --no-restore

  test-dotnet:
    name: .NET Tests (placeholder)
    runs-on: ubuntu-latest
    needs: build-services
    steps:
      - uses: actions/checkout@v4
      - name: Set up .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', 'Directory.Packages.props', 'global.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      - name: Discover and run tests if present
        shell: bash
        run: |
          set -e
          mapfile -t tests < <(git ls-files "**/*.Tests.csproj") || true
          if [ ${#tests[@]} -eq 0 ]; then
            echo "No .NET test projects found. Skipping."
            exit 0
          fi
          for t in "${tests[@]}"; do
            echo "Running tests for $t"
            dotnet test "$t" -c Release --no-build --logger trx
          done

  build-apps:
    name: Build Apps
    runs-on: ubuntu-latest
    needs: [doctor, lint-ui]
    strategy:
      matrix:
        app:
          - api-gateway
          - phos-ui
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            phos/apps/${{ matrix.app }}/package-lock.json
      - name: Install deps
        working-directory: phos/apps/${{ matrix.app }}
        run: npm ci --no-audit --fund=false
      - name: Build api-gateway
        if: matrix.app == 'api-gateway'
        working-directory: phos/apps/api-gateway
        run: npm run build
      - name: Build phos-ui
        if: matrix.app == 'phos-ui'
        working-directory: phos/apps/phos-ui
        run: npm run build

  docker-images:
    name: Docker Build and Push
    runs-on: ubuntu-latest
    needs: [build-services, build-apps, test-dotnet]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push API Gateway
        uses: docker/build-push-action@v6
        with:
          context: phos/apps/api-gateway
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/api-gateway:latest
            ghcr.io/${{ github.repository }}/api-gateway:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: Build and push PHOS UI
        uses: docker/build-push-action@v6
        with:
          context: phos/apps/phos-ui
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/phos-ui:latest
            ghcr.io/${{ github.repository }}/phos-ui:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: Build and push services
        run: |
          declare -a svcs=(lab-interpreter nutrition-kit genome-kit microbiome-kit sleep-kit phos-core phos-sync)
          for svc in "${svcs[@]}"; do
            docker buildx build --push \
              --cache-from type=gha \
              --cache-to type=gha,mode=max \
              -t ghcr.io/${{ github.repository }}/$svc:latest \
              -t ghcr.io/${{ github.repository }}/$svc:${{ github.sha }} \
              phos/services/$svc
          done
