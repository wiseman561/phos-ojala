name: CI

on: [push, pull_request]

jobs:
  discover-frontend:
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.set-matrix.outputs.apps }}
    steps:
      - uses: actions/checkout@v4
      - id: set-matrix
        run: |
          set -e
          list=$(ls -1d src/frontend/* 2>/dev/null | while read d; do if [ -f "$d/package.json" ]; then echo "$d"; fi; done)
          # Build JSON array without external tools
          apps="["
          sep=""
          for d in $list; do
            apps="${apps}${sep}\"${d}\""
            sep=","
          done
          apps="${apps}]"
          if [ "$apps" = "[]" ]; then apps="[]"; fi
          echo "apps=$apps" >> $GITHUB_OUTPUT
          echo "Discovered apps: $apps"

  frontend:
    needs: discover-frontend
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.discover-frontend.outputs.apps) }}
    name: Build FE (${{ matrix.app }})
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Enable Corepack
        run: corepack enable || true
      - name: Prepare pnpm
        run: corepack prepare pnpm@latest --activate || true
      - name: Install deps for ${{ matrix.app }}
        working-directory: ${{ matrix.app }}
        run: |
          if [ -f pnpm-lock.yaml ] || [ -f pnpm-workspace.yaml ]; then
            pnpm install --frozen-lockfile
          elif [ -f package-lock.json ]; then
            npm ci
          elif [ -f yarn.lock ]; then
            yarn install --frozen-lockfile
          else
            npm install
          fi
      - name: Build ${{ matrix.app }}
        working-directory: ${{ matrix.app }}
        run: |
          if [ -f pnpm-lock.yaml ] || [ -f pnpm-workspace.yaml ]; then
            pnpm build || npm run build || yarn build
          elif [ -f yarn.lock ]; then
            yarn build || npm run build
          else
            npm run build || yarn build
          fi

  backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET (respect global.json)
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json
      - name: Restore .NET
        run: |
          if [ -f "Phos.sln" ]; then
            dotnet restore Phos.sln --verbosity minimal
          else
            if compgen -G "src/backend/**/*.csproj" > /dev/null; then
              find src/backend -name "*.csproj" -print0 | xargs -0 -I{} dotnet restore "{}"
            fi
            if compgen -G "tests/**/*.csproj" > /dev/null; then
              find tests -name "*.csproj" -print0 | xargs -0 -I{} dotnet restore "{}"
            fi
          fi
      - name: Build .NET
        run: |
          if [ -f "Phos.sln" ]; then
            dotnet build Phos.sln -c Release --no-restore --verbosity minimal
          else
            if compgen -G "src/backend/**/*.csproj" > /dev/null; then
              find src/backend -name "*.csproj" -print0 | xargs -0 -I{} dotnet build "{}" -c Release --no-restore
            fi
          fi
      - name: Test .NET
        run: |
          if [ -f "Phos.sln" ]; then
            dotnet test Phos.sln -c Release --no-build --verbosity normal
          else
            if compgen -G "tests/**/*Tests*.csproj" > /dev/null; then
              find tests -name "*Tests*.csproj" -print0 | xargs -0 -I{} dotnet test "{}" -c Release --no-build
            else
              echo "No test projects found, skipping."
            fi
          fi
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to Docker Hub
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build Docker images
        run: |
          if [ -f "docker-compose.yml" ]; then
            docker-compose build --parallel
          else
            echo "No docker-compose.yml found, skipping Docker build"
          fi
      - name: Push Docker images
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          services="phos-identity phos-api phos-apigateway phos-healthscore phos-web"
          for service in $services; do
            if docker image inspect "$service:latest" >/dev/null 2>&1; then
              docker tag "$service:latest" "${{ secrets.DOCKERHUB_USER }}/$service:latest"
              docker push "${{ secrets.DOCKERHUB_USER }}/$service:latest"
              echo "Pushed $service"
            else
              echo "Image $service:latest not found, skipping"
            fi
          done
