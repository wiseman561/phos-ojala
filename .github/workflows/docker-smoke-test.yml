name: Docker Smoke Test
on: [push]
jobs:
  smoke-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Build and Start Containers
        run: |
          docker compose up -d --build

      - name: Wait for Healthchecks
        run: |
          echo "Waiting for services to become healthy..."
          # Wait up to 120 seconds for the API Gateway health check
          attempt=0
          max_attempts=24
          until curl -s http://localhost:5100/health || [ $attempt -eq $max_attempts ]; do
            echo "Waiting for API Gateway... ($attempt/$max_attempts)"
            sleep 5
            attempt=$((attempt+1))
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "Error: API Gateway failed to become healthy in time."
            docker compose logs
            exit 1
          fi

          # Verify Frontend is serving
          if ! curl -s http://localhost:3000 | grep -q "<div id=\"root\">"; then
             # Relaxing check slightly if SPA has different root ID or structure
             if ! curl -s http://localhost:3000 | grep -q "<!DOCTYPE html>"; then
               echo "Error: Frontend failed to serve HTML."
               docker compose logs phos-ui
               exit 1
             fi
          fi
          
          echo "All core services verified healthy."

      - name: Stop Containers
        run: |
          docker compose down
